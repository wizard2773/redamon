# RedAmon Reconnaissance Module - Docker Compose
# ===============================================
# Fully containerized OSINT reconnaissance framework
#
# Usage:
#   docker-compose up --build           # Build and run with default target
#   docker-compose up -d                # Run in background
#   docker-compose logs -f recon        # View logs
#   docker-compose down                 # Stop and remove containers
#
# Configure target in recon/params.py or via environment variables

version: '3.8'

services:
  recon:
    build:
      context: ..
      dockerfile: recon/Dockerfile
      network: host
    container_name: redamon-recon

    # Mount Docker socket to allow container to run Docker commands
    # This enables Docker-in-Docker for ProjectDiscovery tools
    volumes:
      # Mount entire recon directory for development (no rebuild needed for code changes)
      - .:/app/recon

      # Docker socket for running Naabu, httpx, Nuclei, etc.
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Shared output volume - accessible by other containers (GVM, etc.)
      - recon-output:/app/recon/output

      # Mount local output for easy access from host
      - ./output:/app/recon/output

      # Mount .env file for secrets (GitHub token, API keys)
      - ./.env:/app/recon/.env:ro

    # Environment variables (override params.py settings)
    environment:
      # Target configuration (uncomment and set to override params.py)
      # - TARGET_DOMAIN=testphp.vulnweb.com
      # - SUBDOMAIN_LIST=
      # - SCAN_MODULES=domain_discovery,port_scan,http_probe,resource_enum,vuln_scan

      # Anonymity settings
      - USE_TOR_FOR_RECON=${USE_TOR_FOR_RECON:-false}

      # Graph DB integration (set to true if Neo4j is running)
      - UPDATE_GRAPH_DB=${UPDATE_GRAPH_DB:-false}

      # User/Project tracking
      - USER_ID=${USER_ID:-default_user}
      - PROJECT_ID=${PROJECT_ID:-default_project}

      # API Keys (from .env file)
      - GITHUB_ACCESS_TOKEN=${GITHUB_ACCESS_TOKEN:-}
      - NVD_API_KEY=${NVD_API_KEY:-}
      - VULNERS_API_KEY=${VULNERS_API_KEY:-}

      # Host path mapping for Docker-in-Docker sibling containers
      # This tells the recon container where ./output is on the host filesystem
      - HOST_RECON_OUTPUT_PATH=${PWD}/output

    # Network mode - host mode needed for Naabu SYN scans
    # Use 'bridge' if you don't need SYN scans (CONNECT scan works without root)
    network_mode: host

    # Required for SYN scans and raw socket access
    cap_add:
      - NET_RAW
      - NET_ADMIN

    # Run as root for SYN scans (set to non-root if using CONNECT scans only)
    # user: root

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

    # Restart policy
    restart: "no"

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Optional: Tor service for anonymous scanning
  # Uncomment to enable Tor support without host Tor installation
  tor:
    image: dperson/torproxy:latest
    container_name: redamon-tor
    profiles:
      - tor  # Only starts with: docker-compose --profile tor up
    ports:
      - "9050:9050"  # SOCKS proxy
      - "9051:9051"  # Control port
    restart: unless-stopped

# Named volumes for data persistence and sharing between containers
volumes:
  # Shared output volume - mount this in other containers to access recon results
  # Example: In gvm_scan docker-compose, add:
  #   volumes:
  #     - recon-output:/data/recon-output:ro
  recon-output:
    driver: local
    name: redamon-recon-output

